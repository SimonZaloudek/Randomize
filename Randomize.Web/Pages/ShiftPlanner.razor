@page "/shiftplanner"
@using Randomize.Core.ShiftPlanner
@using System.Text
@using Microsoft.AspNetCore.Components.Forms
@inject IJSRuntime JS


<h2>Shift Planner Randomizer</h2>

<!-- TIMELINE -->

<p style="margin-bottom:5px">Day Timeline (00:00 Today to 06:00 Next Day)</p>

<div class="timeline-container">

    <div class="timeline-bar">
        @foreach (int hour in Enumerable.Range(0, 31))
        {
            var currentHour = hour % 24; 

            <div class="hour-slot">
                <label class="hour-label">
                    @currentHour:00
                </label>
                <input class="required-input" 
                type="number" 
                min="0" 
                max="40"
                @bind-value="_shift.GetTimeSlot(hour).Demand"
                @bind-value:event="oninput"
                placeholder="0" />

                <select class="priority-select" @bind="_shift.GetTimeSlot(hour).Priority">
                    <option value="1">1 (Low)</option>
                    <option value="2" selected="selected">2 (Medium)</option>
                    <option value="3">3 (High)</option>
                </select>
            </div>
        }
    </div>  
</div>


<!-- ADDING EMPLOYEES -->

<h3 style="margin-top: 8px">Add Employees</h3>

<div class="employee-add-container">
    <input type="text"
    class="employee-input"
    placeholder="Employee name"
    @bind="_newEmployee.Name" />

    <input type="number"
    class="employee-input small"
    placeholder="Max hours (optional)"
    min="0"
    @bind="_newEmployee.MaxHours" />

    <input type="number"
    class="employee-input small"
    placeholder="Start hour (optional)"
    min="0"
    max="30"
    @bind="_newEmployee.ScheduleStart" />

    <input type="number"
    class="employee-input small"
    placeholder="End hour (optional)"
    min="0"
    max="30"
    @bind="_newEmployee.ScheduleEnd" />

    <button class="employee-add-btn" @onclick="AddEmployee">
        <i class="bi bi-person-plus"></i> Add
    </button>
</div>


<!-- EMPLOYEE LIST -->

@if (_employees.Any())
{
    <div class="employee-list">
        @foreach (var emp in _employees)
        {
            <div class="employee-card">

                <div class="employee-list">
                    <strong>@emp.Name:</strong>
                </div>

                <div class="emp-right">
                    <span class="emp-hours">(max @emp.MaxHours h)</span>


                    @if (emp.ScheduleStart.HasValue && emp.ScheduleEnd.HasValue)
                    {
                        <span class="emp-time">@($"{emp.ScheduleStart}:00 – {emp.ScheduleEnd}:00")</span>
                    }
                    else
                    {
                        <span class="emp-time-muted">No schedule</span>
                    }

                    <button class="edit-btn" @onclick="@(() => EditEmployee(emp))" title="Edit employee">
                        <i class="bi bi-pencil-square"></i>
                    </button>

                    <button class="delete-btn" @onclick="@(() => DeleteEmployee(emp))" title="Remove employee">
                        <i class="bi bi-trash"></i>
                    </button>

                </div>
            </div>
        }
    </div>
}


<!-- ACTIONS -->

<div class="employee-actions">
    <button class="btn btn-outline-light me-2" @onclick="SaveEmployees">
        <i class="bi bi-save"></i> Save to TXT
    </button>

    <label class="btn btn-outline-light">
        <i class="bi bi-upload"></i> Load from TXT
        <InputFile OnChange="LoadEmployees" accept=".txt" style="display:none" />
    </label>
</div>



@code {
    private Shift _shift = new();
    private Employee _newEmployee = new();
    private List<Employee> _employees = new();

    protected override void OnInitialized()
    {


    }

    private void AddEmployee()
    {
        if (string.IsNullOrWhiteSpace(_newEmployee.Name))
            return;
        if (_newEmployee.MaxHours == null || _newEmployee.MaxHours > 12 || _newEmployee.MaxHours < 1)
            _newEmployee.MaxHours = _newEmployee.MaxHoursDefault;

        _employees.Add(new Employee
            {
                Name = _newEmployee.Name,
                MaxHours = _newEmployee.MaxHours,
                ScheduleStart = _newEmployee.ScheduleStart,
                ScheduleEnd = _newEmployee.ScheduleEnd
            });

        _newEmployee = new();
    }

    private void DeleteEmployee(Employee emp)
    {
        _employees.Remove(emp);
    }

    private void EditEmployee(Employee emp)
    {
        _newEmployee.Name = emp.Name;
        _newEmployee.MaxHours = emp.MaxHours;
        _newEmployee.ScheduleStart = emp.ScheduleStart;
        _newEmployee.ScheduleEnd = emp.ScheduleEnd;

        _employees.Remove(emp);
    }

    private async Task SaveEmployees()
    {
        var content = EmployeeFileService.WriteEmployees(_employees);
        var bytes = Encoding.UTF8.GetBytes(content);
        await JS.InvokeVoidAsync("downloadFile", "employees.txt", "text/plain", bytes);
    }

    private async Task LoadEmployees(InputFileChangeEventArgs e)
    {
        if (e.FileCount == 0) return;

        var file = e.File;

        const long maxAllowedBytes = 5 * 1024 * 1024; 
        using var stream = file.OpenReadStream(maxAllowedBytes);
        using var reader = new StreamReader(stream, Encoding.UTF8);
        var text = await reader.ReadToEndAsync();

        var loaded = EmployeeFileService.LoadEmployees(text);
        _employees = loaded;
    }

}
